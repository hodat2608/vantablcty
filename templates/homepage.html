{% extends 'main.html' %}

{% block content %}



<div class="home-container">
    
    <div>

        <h3 style="text-align: center;">Danh mục khác</h3>
        <hr>

    </div>

    <div>
        
        <div class="card" >

            <div>
                <form class="form1">
                    <div class="info-search">
                        <i class="fab fa-github fa-lg" style="color: #333333;font-size:48px;"></i> <input style="margin-left: 5px;" type="text" name="query" placeholder="Tìm kiếm" id="searchInput" oninput="searchUser()">
                    </div>
                </form>
                <div id="searchResults">
                    <a data-url="{% url 'post_profile' request.user.id %}"></a>
                </div>
            </div>

           <br>

            <div>
                <div class="txt">
                    <a href="{% url 'post_profile' request.user.id %}">
                        <img class="img123" src="{{ request.user.profileuser.avatar.url }}">
                    </a>
                    <input class="create-button" onclick="toggleCreatePostForm1(event)" placeholder="bạn đang nghĩ gì thế? " >
                </div>
                
            </div>
            
            
        
            <div class="widget-post" aria-labelledby="post-header-title" id="create-post-form" style="display: none;">
                <form action="{% url 'create_post' %}" method="post" enctype="multipart/form-data" class="widget-post__form" aria-label="post widget">
                    {% csrf_token %}
                    <div class="widget-post__content">
                        <label for="post-content" class="sr-only">Share</label>
                        <textarea name="discription" class="widget-post__textarea scroller" placeholder="{{request.user.username}} ơi bạn đang nghĩ gì thế? " id="createbox_post" oninput="validateInput2()"></textarea>
                    </div>
                    <div class="widget-post__actions post--actions">
                        <div class="post-actions__attachments">
                            <button type="button" class="btn post-actions__upload attachments--btn">
                            {% csrf_token %}
                            <label for="upload-image" class="post-actions__label">
                                <i class="fa fa-upload" aria-hidden="true"></i> 
                            </label>
                            </button>
                            <input type="file" name="post_image" id="upload-image" multiple>
                        </div>
                        <div class="post-actions__widget">
                            {% csrf_token %}
                            <button type="submit" class="btnn1" id="createbox_btn_post" disabled >publish</button>
                        </div>
                    </div>             
                </form>
            </div>
            
        </div>
        {% for post in posts%}
        
            <div class="card">
                
                <div>
                    <div class="txt">
                        <a href="{% url 'post_profile' post.post_user_id %}">
                            <img class="img123" src="{{ post.get_post_user_avatar.url }}">  
                        <div class="datesince">
                            <div class="three_dot_post_dropdown">
                                <a href="{% url 'post_profile' post.post_user_id %}">{{ post.post_user }}</a>
                                <div class="dropdown1">
                                    <i class="fas fa-ellipsis-h dropdown1-btn1" data-post-id="{{ post.id }}"></i>
                                    <div class="dropdown1-content1 dropdown1-content1-{{ post.id }}">
                                        <a href="#">Lưu bài viết của {{post.post_user}}<i class="far fa-bookmark"></i></a>
                                        <a href="#">Báo cáo bài viết <i class="fas fa-flag"></i></a>
                                        <a href="#">Ẩn bài viết của {{post.post_user}}<i class="far fa-eye-slash"></i></a>
                                        <a href="#">Bật thông báo bài viết này <i class="far fa-bell"></i></a>
                                    </div>
                                  </div>
                            </div>
                            <li>{{post.created|timesince}} ago at {{ post.formatted_created_time}}</li>
                        </div>
                    </div>
                    <div class="setonu">
                        <h5 class="content-discription" id="content-discription-{{ post.id }}">{{ post.discription }}</h5>
                        <a class="btn-collapse" id="toggle-btn-{{ post.id }}">Xem thêm</a>
                    </div>
                    <br>
                    {% if post.post_image %}
                        <img class="img-post" src =" {{ post.post_image.url}}" width="600">
                    {% endif %}
                </div>
                
                <div>
                    <div class="info-container" data-comment="{{ post.commentviews_set.count }}">
                        {% if request.user in post.post_likes.all %} 
                            {% if post.post_likes.count > 1 %}
                                <div class="left-align">
                                    <p class="my-text" id="like-count-{{ post.id }}">Bạn và {{ post.post_likes.count }} người khác <i class="fas fa-thumbs-up"></i></p>
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p>
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %} 
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %} 
                                </div>  
                            {% else %} 
                                <div class="left-align">
                                    <p class="my-text" id="like-count-{{ post.id }}" >Bạn <i class="fas fa-thumbs-up"></i></p>
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p> 
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %}
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                        {% else %}
                            {% if post.post_likes.count > 0 %}
                                <div class="left-align">
                                    <p  class="my-text" id="like-count-{{ post.id }}">{{ post.post_likes.count }} like{{ post.post_likes.count|pluralize }} <i class="fas fa-thumbs-up"></i></p> 
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p> 
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %}
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="left-align">
                                    <p  class="my-text" id="like-count-{{ post.id }}"></i></p>
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p> 
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %}
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %}
                                </div>
                            {% endif %}   
                        {% endif %} 
                        
                    </div>
                    <!-- <div id="list_like-{{ post.id }}" >  
                        {% for user in post.post_likes.all %} 
                            <p>{{user.username}}</p>
                        {% endfor %}
                    </div> -->
                </div>
                
                <hr>

                <div class="btn-group">

                    <form action="{% url 'post_likes_homepage' 0 %}" method="post" id="like-form" data-like-id="{{ post.id }}" 
                        data-liked="{% if request.user in post.post_likes.all %} true {% else %} false {% endif %}"> 
                        {% csrf_token %}
                        <button type="submit" id="like-button-{{ post.id }}">
                            {% if request.user in post.post_likes.all %}
                                <a class="my-text"><i class="fas fa-thumbs-up"></i> Like</a>
                            {% else %}
                            <i class="fas fa-thumbs-up"></i> Like
                            {% endif %}
                        </button>
                    </form>

                    <!-- <button  onclick="turnoncommentAndRefresh('{{ post.id }}')"><i class="fas fa-comment"></i> Comment</button> -->
                     
                    <!-- <button  onclick="toggleCommentPopupWithDelay('{{ post.id }}')"><i class="fas fa-comment"></i> Comment</button> -->

                    <!-- <form action="{% url 'update_post_likes' 0 %}" method="post">
                        {% csrf_token %}
                        <button  onclick="toggleCommentPopupWithDelay('{{ post.id }}')"><i class="fas fa-comment"></i> Comment</button>
                    </form> -->
                    <form id="like-form" method="post">
                        {% csrf_token %}
                        <button type="button" onclick="toggleCommentPopupWithDelay('{{ post.id }}')"><i class="fas fa-comment"></i> Comment</button>
                    </form>

                    <button type="submit" id="share-button-{{ post.id }}"> <i class="fas fa-share"></i> Share</button>

                </div>

            </div>   
           
        
            <div class="card-sharepost_popup" id="share-card-{{ post.id }}" style="display:none;"> 
                <form action="{% url 'share_post_views' 0 %}" method="post" id="share-form" data-share-id="{{ post.id }}">
                    {% csrf_token %}
                    <div class="txt">
                        <a href="{% url 'post_profile' request.user.id %}">
                            <img class="img123" src="{{ request.user.profileuser.avatar.url }}">
                        <a href="{% url 'post_profile' request.user.id %}">{{request.user.username}}</a>
                    </div>
                    
                    <textarea name='discription_sh' id="discription_sh" class="share-discription scroller" placeholder="say something about this post "></textarea>
                    
                    <div class="card-sharepost-inner"> 
                        <div class="txt">
                            <a href="{% url 'post_profile' post.post_user_id %}">
                            <img class="img123" src="{{ post.get_post_user_avatar.url }}">  
                            <div class="datesince">
                                <a href="{% url 'post_profile' post.post_user_id %}">{{ post.post_user }}</a>
                                <li>{{post.created|timesince}} ago</li>
                            </div>
                        </div>
                        <div class="setonu">
                            <h5 class="content-discription" id="content-discription-{{ post.id }}">{{ post.discription }}</h5>
                            <a class="btn-collapse" id="toggle-btn-{{ post.id }}">Xem thêm</a>
                        </div>
                        {% if post.post_image %}
                            <img class="img-post" src =" {{ post.post_image.url}}" width="600">
                        {% endif %}                       
                        
                    </div>
                    <br>
                    <button class="btnn" type="submit">Share post </button>
                    <br>
                </form>
            </div>

            <div class="popup" id="comment-popup-{{ post.id }}" style="display: none;">

                <div class="card-shadow">
                    
                    <div>   
                        <div class="txt">
                            <a href="{% url 'post_profile' post.post_user_id %}">
                                <img class="img123" src="{{ post.get_post_user_avatar.url }}">  
                            <div class="datesince">
                                <div class="close_icon_popup_comment_section">
                                    <a href="{% url 'post_profile' post.post_user_id %}">{{ post.post_user }}</a>
                                    <button onclick="closePopupAndReload()"><i class="fas fa-times"></i></button>
                                </div>
                                <li>{{post.created|timesince}} ago</li>
                            </div>
                        </div>

                        <div class="setonu">
                            <h5 class="content-discription" id="content-discription-{{ post.id }}">{{ post.discription }}</h5>
                            <a class="btn-collapse" id="toggle-btn-{{ post.id }}">Xem thêm</a>
                        </div>
                        {% if post.post_image %}
                            <img class="img-post-popup" src =" {{ post.post_image.url}}" width="640" >
                        {% endif %}   
                        
                    </div> 

                    <div class="info-container">
                        {% if request.user in post.post_likes.all %} 
                            {% if post.post_likes.count > 1 %}
                                <div class="left-align">
                                    <p id="like-count-section-{{ post.id }}">Bạn và {{ post.post_likes.count }} người khác <i class="fas fa-thumbs-up"></i></p>
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p>
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %} 
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %} 
                                </div>  
                            {% else %} 
                                <div class="left-align">
                                    <p class="my-text" id="like-count-section-{{ post.id }}">Bạn <i class="fas fa-thumbs-up"></i></p>
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p> 
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %}
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                        {% else %}
                            {% if post.post_likes.count > 0 %}
                                <div class="left-align">
                                    <p id="like-count-section-{{ post.id }}">{{ post.post_likes.count }} like{{ post.post_likes.count|pluralize }} <i class="fas fa-thumbs-up"></i></p> 
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p> 
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %}
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="left-align">
                                    <p id="like-count-section-{{ post.id }}"></i></p>
                                </div>
                                <div class="right-align">
                                    {% if post.commentviews_set.count >= 1 %}
                                        <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}} <i class="fas fa-comment"></i></p> 
                                    {% else %} 
                                        <p>.</p>
                                    {% endif %}
                                    {% if post.post_shares.count > 0 %}
                                        <p>{{ post.post_shares.count }} share{{post.post_shares.count|pluralize}} <i class="fas fa-share"></i></p>
                                    {% else %}
                                        <p>.</p>
                                    {% endif %}
                                </div>
                            {% endif %}   
                        {% endif %} 
                        
                    </div>
            
                    <div class="btn-group"> 
                        <form action="{% url 'post_like_post_comment_section' 0 %}" method="post" id="like-popup-form" data-like-id-section="{{ post.id }}"
                        data-liked-section="{% if request.user in post.post_likes.all %} true {% else %} false {% endif %}" >
                            {% csrf_token %}
                            <button type="submit" id="like-button-section-{{ post.id }}"> 
                                {% if request.user in post.post_likes.all %}
                                <a class="my-text"><i class="fas fa-thumbs-up"></i>Like</a>
                                {% else %}
                                <i class="fas fa-thumbs-up"></i> Like 
                                {% endif %}
                            </button >
                        </form>
                        <form action="#">
                            {% csrf_token %}  
                            <button type="submit"> <i class="fas fa-comment"></i> Comment</button>
                        </form>
                        
                        <button type="submit" id="share-button-{{ post.id }}"> <i class="fas fa-share"></i> Share</button>
                    </div>      
                    <hr>
                    <div class="message-form-1">
                        <form action="{% url 'send_comment' 0 %}" id="send-comment" data-send-id="{{ post.id }}" method="post" enctype="multipart/form-data" >
                            {% csrf_token %}
                            <div class="form-row-1">
                                <input type="text" name="message" id="message" placeholder="Type your message">
                                <label for="massage_image" class="upload-icon">
                                    <input type="file" name="massage_image" id="massage_image" multiple>
                                    <i class="fas fa-file-image"></i>
                                </label>
                                <button type="submit" class="send-button">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    <br>
                    <div class="box_chat">
                        <div id="comment-section-{{ post.id }}">    
                            <!-- commmet will put on here -->
                        </div>   
                        {% for comment in post.commentviews_set.all %}
                        <div class="hello" id="delete-comment-{{ comment.id }}">
                            <div class="comment-avatar">
                                <div>
                                    <a href="{% url 'post_profile' comment.comment_user_id %}">
                                    <img class="img12" src="{{ comment.get_comment_user_avatar.url }}">
                                </div>
                                <div class="comment-card1">
                                    <div class="dua_len_ngang_hang_va_dieu_chinh_khoang_cach">
                                        <div id="comment-{{ comment.id }}">                                           
                                            <div class="txt">
                                                <a href="{% url 'post_profile' comment.comment_user_id %}">{{comment.comment_user }}</a>
                                            </div>
                                            <small class="formatted-text">{{ comment.message }}</small>
                                        </div>
                                        <div class="dropdown">
                                            <span onclick="myFunction('{{ comment.id }}')" class="dropbtn"><i class="fas fa-ellipsis-v"></i></span>
                                            <div id="myDropdown-{{ comment.id }}" class="dropdown-content dropdown-{{ comment.id }}">
                                                {% if comment.comment_user == request.user %}
                                                <a href="{% url 'del_comment' comment.id %}" onclick="deleteComment('{{ comment.id }}')" >del_comment</a>
                                                {% endif %}
                                                <a>Modify</a>
                                                <a>report comment</a>
                                            </div>
                                        </div> 
                                    </div>
                                    <div>
                                        {% if comment.massage_image %}
                                            <div class="dropdown-image">
                                                <img src="{{ comment.massage_image.url }}" width="150" height="100">
                                                <div class="dropdown-content-image">
                                                    {% if comment.massage_image %}
                                                        <img src="{{ comment.massage_image.url }}" width="500" height="400">
                                                    {% endif %}                                                    
                                                    <div class="desc">Cinque Terre Unique</div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="mode-font-rep" data-repply-form="{{ comment.id }}">Phản hồi</button>  
                                <button class="mode-font-like">Like</button> 
                            </div>
                            <div class="message-form">
                                <form action="{% url 'repply_comment' 0 %}" data-comment-id="{{ comment.id }}" id="repply-form-{{ comment.id }}"  method="post" enctype="multipart/form-data" style ="display: none;">
                                    {% csrf_token %}
                                    <div class="form-row">
                                        <input type="text" name="rep_message" placeholder="Type your message">
                                        <label for="rep_mess_image" class="upload-icon">
                                            <input type="file" name="rep_mess_image" id="rep_mess_image" multiple>
                                            <i class="fas fa-file-image"></i>
                                        </label>
                                        <button type="submit" class="send-button">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            </div> 
                            <div id="repply-section-{{ comment.id }}">
                                <!-- Đây là nơi chứa các repply -->
                            </div>
                            <div>
                                {% if comment.repply_commentviews_set.all %}
                                    {% for rep_comment in comment.repply_commentviews_set.all %}
                                        <div class="comment-cad-repply"> 
                                            <h5><a href=" {% url 'post_profile' rep_comment.user_rep_id %}">@{{ rep_comment.user_rep.username }}</a></h5>
                                            <a class="formatted-text">{{ rep_comment.rep_message }}</a>   
                                            <div>
                                                {% if rep_comment.rep_mess_image %}
                                                    <h1><img src="{{ rep_comment.rep_mess_image.url }}" width="100" height="100"></h1>
                                                {% endif %}
                                            </div>                           
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div> 
                        </div>
                        <br>
                        {% endfor %}
                    </div>      
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div>
        <h3 style="text-align: center;">Đang hoạt động</h3>
        <hr>
    </div>

</div>

<script 
    src="https://code.jquery.com/jquery-3.5.1.js" 
    integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" 
    crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>


<script>
var scrollPosition = localStorage.getItem("scrollPosition");
if (scrollPosition) {
    $(window).scrollTop(scrollPosition);
    localStorage.removeItem("scrollPosition");
}

$(document).on('submit', '#like-form', function(e) {
    e.preventDefault();
    var form = $(this);
    var likeId = form.data('like-id');
    var isLiked = form.data('liked');
    var count_comment =form.data('comment')

    $.ajax({
    type: 'POST',
    url: '/post_likes_homepage/' + likeId + '/',
    data: {
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
    },
    success: function(data) {
        var Liked_button = $('#like-button-'+ likeId);
        var Liked_count =  $('#like-count-' + likeId);
        var Liked_user =   $('#list_like-'  + likeId);
        var thongdiep =  $('#thongdiep-'  + likeId);

        if (data.liked) {
            Liked_button.html('<i class="fas fa-thumbs-up"></i> Like').css('color', 'blue').css('font-weight', 'normal');
            form.data('liked',true);
            if (data.likes_count > 0) {
                Liked_count.html(data.likes_count + ' like' + (data.likes_count > 1 ? 's' : '') +'  <i class="fas fa-thumbs-up"></i>').css('color', 'blue').css('font-weight', 'normal');
                } else {
                    Liked_count.text(''); 
                }
        }
        else {
            Liked_button.html('<i class="fas fa-thumbs-up"></i> Like').css('color', 'black').css('font-weight', 'normal');
            form.data('liked',false);
            if (data.likes_count > 0) {
                Liked_count.text(data.likes_count + ' like' + (data.likes_count > 1 ? 's' : ''));
                } else {
                    Liked_count.text(''); 
                }
        };
        Liked_user.empty();
            for (var i = 0; i < data.all_user_like.length; i++) {
                Liked_user.append(data.all_user_like[i]);};
    }
    });
});



$(document).on('submit', '#like-popup-form', function(e) {
    e.preventDefault();
    var form = $(this);
    var likeId_1 = form.data('like-id-section');
    var section_data = form.data('liked-section')
    var popup = document.getElementById("comment-popup-" + likeId_1);
    var popupScrollPosition = $(popup).scrollTop();

    $.ajax({
        type: 'POST',
        url: '/post_like_post_comment_section/' + likeId_1 + '/',
        data: {
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(data) {
            var liked_button_section = $('#like-button-section-' + likeId_1);
            var liked_count_section = $('#like-count-section-' + likeId_1);

            if (data.liked_section) {
            liked_button_section.html('<i class="fas fa-thumbs-up"></i> Like').css('color', 'blue').css('font-weight', 'normal');
            form.data('liked-section',true);
            if (data.likes_count_section > 0) {
                liked_count_section.html(data.likes_count_section + ' like' + (data.likes_count_section > 1 ? 's' : '') +' <i class="fas fa-thumbs-up"></i>').css('color', 'blue').css('font-weight', 'normal');
                } else {
                    liked_count_section.text(''); 
                }   
        }
        else {
            liked_button_section.html('<i class="fas fa-thumbs-up"></i> Like').css('color', 'black');
            form.data('liked-section',false);
            if (data.likes_count_section > 0) {
                liked_count_section.html(data.likes_count_section + ' like' + (data.likes_count_section > 1 ? 's' : ''));
                } else {
                    liked_count_section.text(''); 
                }
           
        };         
        }
    });
});

var currentPostID = null;
function toggleCommentPopupWithDelay(postID) {
    if (currentPostID !== postID) {
        closeCommentPopup();
        currentPostID = postID;
        setTimeout(function() {
            var popup = document.getElementById("comment-popup-" + postID);
            popup.style.display = "block";
            $.ajax({
                type: 'POST',
                url: '/update_post_likes/' + postID + '/',
                success: function(data) {
                    var liked_button_section = $('#like-button-section-' + postID);
                    var liked_count_section = $('#like-count-section-' + postID);

                    if (data.update_like) {
                        liked_button_section.html('<i class="fas fa-thumbs-up"></i> Like').css('color', 'blue').css('font-weight', 'normal');
                        form.data('liked-section',true);
                        liked_count_section.html(data.update_like_count + ' like' + (data.update_like_count > 1 ? 's' : '') +' <i class="fas fa-thumbs-up"></i>').css('color', 'blue').css('font-weight', 'normal');
                    } else {
                        liked_button_section.html('<i class="fas fa-thumbs-up"></i> Like').css('color', 'black');
                        form.data('liked-section',false);
                        liked_count_section.html(data.update_like_count + ' like' + (data.update_like_count > 1 ? 's' : ''));
                    }
                }
            });
        }, 10);
    } else {
        closeCommentPopup();
        currentPostID = null;
    }
}
function closeCommentPopup() {
    if (currentPostID !== null) {
        var popup = document.getElementById("comment-popup-" + currentPostID);
        popup.style.display = "none";
        currentPostID = null;
    }
}
function closePopupAndReload() {
    closeCommentPopup();
    var scrollPosition = $(window).scrollTop();
    localStorage.setItem("scrollPosition", scrollPosition);
    setTimeout(function() {
        location.reload();
    }, 10);
}

$(document).ready(function() {
    var popupScrollPosition_cmt = localStorage.getItem("popupScrollPosition_cmt"); 
    var sendcommentId = localStorage.getItem("sendcommentId"); 
    
    if (popupScrollPosition_cmt && sendcommentId) {
        var popup = document.getElementById("comment-popup-" + sendcommentId);
        popup.style.display = "block";
        popup.scrollTop = popupScrollPosition_cmt; 
        localStorage.removeItem("popupScrollPosition_cmt"); 
        localStorage.removeItem("sendcommentId"); 
    }
});

function turnoncommentAndRefresh(postID) {
    var scrollPosition = $(window).scrollTop();
    localStorage.setItem("scrollPosition", scrollPosition);
    setTimeout(function() {
        location.reload();
    }, 10);
    sessionStorage.setItem("currentPostID", postID);
            }
    window.onload = function() {
        var currentPostID = sessionStorage.getItem("currentPostID");
        if (currentPostID) {
            sessionStorage.removeItem("currentPostID");
            setTimeout(function() {
                var popup = document.getElementById("comment-popup-" + currentPostID);
                if (popup) {
                    popup.style.display = "block";
                }
            },10);
        }
};

function searchUser() {
    var query = document.getElementById("searchInput").value;
    var searchResultsDiv = document.getElementById("searchResults");
    if (!query) {
        searchResultsDiv.innerHTML = "";
        return;
    }
    $.ajax({
        type: 'GET',
        url: '/search_user/',
        data: { query: query },
        success: function(data) {
            var URL = $("#searchResults a").data("url");
            var resultsHTML = ""; 
            resultsHTML += "<br><li>Kết quả tìm kiếm: </li><br>"
            for (var i = 0; i < data.length; i++) {
                
                // resultsHTML += '<div class="info-search"> <img class="img12345" src="' + data[i].avatar + '">  <a class="testjs" href="' + data[i].profile_url + '">' + data[i].username + '</a> </div> <br>';
                resultsHTML += '<div class="info-search"> <a href="'+ data[i].profile_url +'"> <img class="img12345" src="' + data[i].avatar + '"></a>  <a class="testjs" href="' + data[i].profile_url + '">' + data[i].username + '</a> </div> <br>';
            }
            
                
            
            searchResultsDiv.innerHTML = resultsHTML; 
        },
        error: function() {
            searchResultsDiv.innerHTML = "<p>Đã xảy ra lỗi khi tìm kiếm</p>";
        }
    });
}

function sharePost(postId) {
    var popupCard = document.getElementById('share-card-' + postId);
    popupCard.style.display = 'block';
}

document.addEventListener('click', function(event) {
    var targetElement = event.target;
    if (targetElement.tagName === 'BUTTON' && targetElement.id.startsWith('share-button-')) {
        var postId = targetElement.id.slice('share-button-'.length);
        sharePost(postId);
    } else {
        var allPopups = document.querySelectorAll('.card-sharepost_popup');
        allPopups.forEach(function(popup) {
            if (popup.style.display === 'block' && !popup.contains(targetElement)) {
                popup.style.display = 'none';
            }
        });
    }
});

$(document).on('submit', '#share-form', function(e) {
    e.preventDefault();
    var form = $(this);
    var shareId = form.data('share-id');
    var discription_sh = form.find('textarea[name="discription_sh"]').val();
    var formData = new FormData();
    formData.append('discription_sh', discription_sh);
    formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
    toastr.options.timeOut = 4000;
    $.ajax({
        type: 'POST',
        url: '/share_post_views/' + shareId + '/',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {  
            var scrollPosition = $(window).scrollTop();
            localStorage.setItem("scrollPosition", scrollPosition);
            if (data.boolean){
                toastr.success('Đã chia sẻ bài viết lên trang cá nhân của bạn!', 'Thông báo');
                setTimeout(function() {location.reload(); }, 1000);} 
            else {
                toastr.success('Bạn đã chia sẽ bài viết này 1 lần rồi', 'Thông báo');
                setTimeout(function() {location.reload(); }, 1000);
            }     
        }
    });
});

const posts = document.getElementsByClassName("setonu");
for (let i = 0; i < posts.length; i++) {
    const post = posts[i];
    const postID = post.querySelector(".content-discription").id.split("-")[2];
    const content = document.getElementById("content-discription-" + postID);
    const toggleBtn = document.getElementById("toggle-btn-" + postID);

    const originalHeight = "97px"; // Giá trị max-height ban đầu
    content.style.maxHeight = originalHeight;

    if (content.scrollHeight > parseInt(originalHeight)) {
        toggleBtn.style.display = "inline";
    } else {
        toggleBtn.style.display = "none";
    }

    toggleBtn.addEventListener("click", function() {
        if (content.style.maxHeight === originalHeight) {
            content.style.maxHeight = content.scrollHeight + "px";
            toggleBtn.textContent = "Thu gọn";
        } else {
            content.style.maxHeight = originalHeight;
            toggleBtn.textContent = "Xem thêm";
        }
    });
}

document.addEventListener("DOMContentLoaded", function() {
      const dropdownBtns = document.querySelectorAll(".dropdown1-btn1");

      dropdownBtns.forEach(function(btn) {
        btn.addEventListener("click", function() {
          const postId = this.dataset.postId;
          const dropdownContent = document.querySelector(`.dropdown1-content1-${postId}`);
          dropdownContent.classList.toggle("show1");
        });
      });

      window.addEventListener("click", function(event) {
        if (!event.target.matches(".dropdown1-btn1")) {
          const dropdownContents = document.querySelectorAll(".dropdown1-content1");
          dropdownContents.forEach(function(content) {
            if (content.classList.contains("show1")) {
              content.classList.remove("show1");
            }
          });
        }
      });
    });

  

$(document).on('submit', '#send-comment', function(e) {
    e.preventDefault();
    var form = $(this);
    var sendcommentId = form.data('send-id');
    var message = form.find('input[name="message"]').val();
    var massageImage = $("#massage_image").prop('files')[0];
    var formData = new FormData();
    formData.append('message', message);
    formData.append('massage_image', massageImage);
    formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
    $.ajax({
        type: 'POST',
        url: '/send_comment/' + sendcommentId + '/',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            var comment_user_username = data.comment_user_username; 
            var comment_massage = data.comment_massage;
            var comment_massage_image = data.comment_massage_image;
            var comment_id = data.comment_id;
            var profile_url = data.profile_url;
            var avatar_url = data.avatar_url;
            var user = data.user
            console.log('ajax0:',comment_user_username);
            console.log('ajax1:',comment_id);
            var hasCommentImage = comment_massage_image && comment_massage_image.trim() !== '';
            var comment_imageHTML = '';
                if (hasCommentImage) {
                    comment_imageHTML = ` 
                                            <div class="dropdown-image">
                                                <img src="`+comment_massage_image+`" width="150" height="100">
                                                <div class="dropdown-content-image">
                                                    <img src="`+comment_massage_image+`" width="500" height="400">                                                 
                                                    <div class="desc">Cinque Terre Unique</div>
                                                </div>
                                            </div>
                                        `
                }; 
            var dropbox ='';
                if (comment_user_username===user) {
                    dropbox = `
                                <form action="{% url 'del_comment' 0 %}" method="post" id="del_comments" data-del-id="`+comment_id+`">
                                    {% csrf_token %}
                                    <button type="submit">delete</button>
                                </form>`
                };

            var NewCommentHTML =`   <div class="hello">
                                        <div class="comment-avatar">
                                            <div>
                                                <a href="`+profile_url+`">
                                                <img class="img12" src="`+avatar_url+`">
                                            </div>
                                            <div class="comment-card1">
                                                <div class="dua_len_ngang_hang_va_dieu_chinh_khoang_cach">
                                                    <div id="comment-`+comment_id+`">                                           
                                                        <div class="txt">
                                                            <a href="`+profile_url+`">`+comment_user_username+`</a>
                                                        </div>
                                                        <small class="formatted-text">`+comment_massage+`</small>
                                                    </div>
                                                    <div class="dropdown">
                                                        <span onclick="myFunction('`+comment_id+`')" class="dropbtn"><i class="fas fa-ellipsis-v"></i></span>
                                                        <div id="myDropdown-`+comment_id+`" class="dropdown-content dropdown-`+comment_id+`">
                                                            `+dropbox+`
                                                            <a>Modify</a>
                                                            <a>report comment</a>
                                                        </div>
                                                    </div> 
                                                </div>
                                            </div>
                                        </div>
                                    `
            if(hasCommentImage) {
                NewCommentHTML +=
                                    `       
                                            <div>
                                                `+comment_imageHTML+`
                                            </div>                                           
                                        
                                    `}  ;
                NewCommentHTML +=   `   
                                        <div>
                                            <button class="mode-font-rep" data-repply-form="`+ comment_id +`">Phản hồi</button>
                                            <button class="mode-font-like">Like</button> 
                                        </div>
                                    `
                NewCommentHTML +=   `
                                        <div class="message-form">
                                            <form action="{% url 'repply_comment' 0 %}" method="post" data-comment-id="`+comment_id+`" id="repply-form-`+comment_id+`" enctype="multipart/form-data" style ="display: none;">  
                                                {% csrf_token %}
                                                <div class="form-row">
                                                    <input type="text" name="rep_message" placeholder="Type your message">
                                                    <label for="rep_mess_image" class="upload-icon">
                                                        <input type="file" name="rep_mess_image" id="rep_mess_image" multiple>
                                                        <i class="fas fa-file-image"></i>
                                                    </label>
                                                    <button type="submit" class="send-button">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>     
                                        <div id="repply-section-`+ comment_id +`">
                                            
                                        </div>
                                    </div> 
                                    <br>
                                    `
            var newComment = $(NewCommentHTML);
            $("#comment-section-" + sendcommentId).prepend(newComment);  


            $(document).on('submit', 'form[id^="repply-form-"]', function(e){
                e.preventDefault();
                var form = $(this);
                var comment_id = form.data('comment-id');
                console.log('ajax:',comment_id)
                var rep_message = form.find('input[name="rep_message"]').val();
                var rep_mess_image = form.find('input[name="rep_mess_image"]').prop('files')[0];
                var formData = new FormData(this); 
                formData.append('rep_message', rep_message);
                formData.append('rep_mess_image', rep_mess_image);
                formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
            $.ajax({
                type: 'POST',
                url: '/repply_comment/' + comment_id + '/',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    var repply_id = data.repply_id;
                    var repply_user_username = data.repply_user_username;
                    var repply_user_id = data.repply_user_id;
                    var repply_rep_message = data.repply_rep_message;
                    var repply_rep_mess_image = data.repply_rep_mess_image;
                    var profile_url_repply = data.profile_url_repply;
                    var avatar_url_rp = data.avatar_url_rp;
                    var hasRPCommentImage = repply_rep_mess_image && repply_rep_mess_image.trim() !== '';
                    var repply_comment_imageHTML = '';
                        if (hasRPCommentImage) {repply_comment_imageHTML =  `<img src="`+repply_rep_mess_image+`" width="100" height="100"`};

                    var NewRepplyCommentHTML=   `   
                                                    <div class="comment-cad-repply"> 
                                                        <div>
                                                            <a href="`+profile_url_repply+`">
                                                            <img class="img12" src="`+avatar_url_rp+`">
                                                        </div>
                                                        <a href="` + profile_url_repply +`">`+repply_user_username+`</a>
                                                        <a class="formatted-text">`+repply_rep_message+`</a> ` 
                    if (hasRPCommentImage){                                     
                        NewRepplyCommentHTML +=                                
                                                        `<div>
                                                            ` + repply_comment_imageHTML +`
                                                        </div>                           
                                                    </div>                                                   
                                                `};
                    var newrepplyComment = $(NewRepplyCommentHTML);
                    $("#repply-section-" + comment_id).append(newrepplyComment);

                },
                error: function(error) {}
                    
            });

            $(document).on('submit', '#del_comments', function(e) {
                e.preventDefault();
                var form = $(this);
                var DelcommentId = data.comment_id;
                $.ajax({
                    type: 'POST',
                    url: '/del_comment/' + DelcommentId + '/',
                    data: {
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val() 
                    },
                    success: function(data) {
                        if (data.commit) {
                            $('#delete-comment-' + DelcommentId).remove();
                        } else {
                            alert('Không thể xóa comment: ' + data.error);
                        }
                    },    
            });
            });

            $(document).on("click", ".mode-font-rep", function(event) {
                event.preventDefault();
                var commentId = $(this).data("repply-form");
                toggleRepplyForm(event, "repply-form-" + commentId);
                });
            function toggleRepplyForm(event, repply_formId) {
                event.preventDefault();
                var formDiv = document.getElementById(repply_formId);
                formDiv.style.display = formDiv.style.display === "none" ? "block" : "none";
                }
            });
        } 
    });
});


$(document).on('submit', 'form[id^="repply-form-"]', function(e) {
    e.preventDefault();
    var form = $(this);
    var comment_id = form.data('comment-id');
    console.log('ajax:',comment_id)
    var rep_message = form.find('input[name="rep_message"]').val();
    var rep_mess_image = form.find('input[name="rep_mess_image"]').prop('files')[0];
    var formData = new FormData(this); 
    formData.append('rep_message', rep_message);
    formData.append('rep_mess_image', rep_mess_image);
    formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
$.ajax({
    type: 'POST',
    url: '/repply_comment/' + comment_id + '/',
    data: formData,
    processData: false,
    contentType: false,
    success: function(data) {
        var repply_id = data.repply_id;
        var repply_user_username = data.repply_user_username;
        var repply_user_id = data.repply_user_id;
        var repply_rep_message = data.repply_rep_message;
        var repply_rep_mess_image = data.repply_rep_mess_image;
        var profile_url_repply = data.profile_url_repply;
        var avatar_url_rp = data.avatar_url_rp;
        var hasRPCommentImage = repply_rep_mess_image && repply_rep_mess_image.trim() !== '';
        var repply_comment_imageHTML = '';
            if (hasRPCommentImage) {repply_comment_imageHTML =  `<img src="`+repply_rep_mess_image+`" width="100" height="100"`};

        var NewRepplyCommentHTML=   `   
                                        <div class="comment-cad-repply"> 
                                            <div>
                                                <a href="`+profile_url_repply+`">
                                                <img class="img12" src="`+avatar_url_rp+`">
                                            </div>
                                            <a href="` + profile_url_repply +`">`+repply_user_username+`</a>
                                            <a class="formatted-text">`+repply_rep_message+`</a> ` 
        if (hasRPCommentImage){                                     
            NewRepplyCommentHTML +=                                
                                            `<div>
                                                ` + repply_comment_imageHTML +`
                                            </div>                           
                                        </div>                                                   
                                    `};
        var newrepplyComment = $(NewRepplyCommentHTML);
        $("#repply-section-" + comment_id).append(newrepplyComment);

    },
    error: function(error) {}
});
});
$(document).on('submit', '#del_comments', function(e) {
    e.preventDefault();
    var form = $(this);
    var DelcommentId = form.data('del-id');
    $.ajax({
        type: 'POST',
        url: '/del_comment/' + DelcommentId + '/',
        data: {
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val() 
        },
        success: function(data) {
            if (data.commit) {
                $('#delete-comment-' + DelcommentId).remove();
            } else {
                alert('Không thể xóa comment: ' + data.error);
            }
        },     
});
})

$(document).on("click", ".mode-font-rep", function(event) {
  event.preventDefault();
  var commentId = $(this).data("repply-form");
  toggleRepplyForm(event, "repply-form-" + commentId);
});
function toggleRepplyForm(event, repply_formId) {
  event.preventDefault();
  var formDiv = document.getElementById(repply_formId);
  formDiv.style.display = formDiv.style.display === "none" ? "block" : "none";
}


</script> 

{% endblock %}




